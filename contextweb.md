# PromptHub Webåº”ç”¨æ”¹é€ æ–¹æ¡ˆ

åŸºäºå·²å®Œæˆçš„æ•°æ®åº“å’ŒMCPæ¶æ„ï¼Œæˆ‘è®¾è®¡äº†ä¸€å¥—å…¨é¢ä¸”å¯è¡Œçš„PromptHub Webåº”ç”¨æ”¹é€ æ–¹æ¡ˆã€‚
æ€»ä½“ç›®æ ‡ï¼šä¸Šä¸‹æ–‡å·¥ç¨‹æ§åˆ¶ä¸­å¿ƒ (Context Engineering Control Center)
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†Web UIä»ä¸€ä¸ªç®€å•çš„æç¤ºè¯åº“ï¼Œè½¬å˜ä¸ºä¸€ä¸ªå…¨é¢çš„ä¸Šä¸‹æ–‡å·¥ç¨‹æ§åˆ¶ä¸­å¿ƒã€‚è¿™å°†ä½¿ç”¨æˆ·å’Œç®¡ç†å‘˜èƒ½å¤Ÿç®¡ç†ã€ä¸ªæ€§åŒ–å¹¶ä¼˜åŒ–æ™ºèƒ½æç¤ºè¯å’ŒAI Agentçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

## è®¾è®¡åŸåˆ™

* åŸºäºè§’è‰²çš„ä½“éªŒ (Role-Based Experience)ï¼šUIåº”æ ¹æ®ç”¨æˆ·è§’è‰²è¿›è¡Œè°ƒæ•´ã€‚
  * æ™®é€šç”¨æˆ·: ä¸“æ³¨äºä¸ªæ€§åŒ–è®¾ç½®å’Œäº¤äº’å†å²ã€‚
  * æç¤ºè¯åˆ›å»ºè€…: æä¾›å¼ºå¤§çš„å·¥å…·æ¥åˆ›å»ºåŠ¨æ€æç¤ºè¯ã€‚
  * ç®¡ç†å‘˜: æä¾›ç³»ç»Ÿçº§çš„åˆ†æå’Œå®éªŒç®¡ç†åŠŸèƒ½ã€‚
* ç›´è§‚çš„æŠ½è±¡åŒ– (Intuitive Abstraction)ï¼šå°†JSONBå’Œè§„åˆ™å¼•æ“çš„å¤æ‚æ€§éšè—åœ¨ç”¨æˆ·å‹å¥½çš„ç•Œé¢ï¼ˆå¦‚å¯è§†åŒ–æ„å»ºå™¨ã€ç»“æ„åŒ–è¡¨å•ï¼‰ä¹‹åã€‚
* æ¸è¿›å¼æŠ«éœ² (Progressive Disclosure)ï¼šé»˜è®¤æ˜¾ç¤ºåŸºæœ¬é€‰é¡¹ï¼Œå¹¶å…è®¸ç”¨æˆ·å±•å¼€ä»¥æŸ¥çœ‹é«˜çº§é…ç½®ã€‚
* æ•°æ®é©±åŠ¨çš„UI (Data-Informed UI)ï¼šåˆ©ç”¨æ–°çš„åˆ†æè§†å›¾ï¼Œç›´æ¥åœ¨ç•Œé¢ä¸­ä¸ºåˆ›å»ºè€…å’Œç®¡ç†å‘˜æä¾›å¯æ“ä½œçš„æ´å¯Ÿã€‚
*

### ç¬¬ä¸€é˜¶æ®µï¼šæç¤ºè¯è¯¦æƒ…é¡µæ”¹é€ 

å¦‚æœç”¨æˆ·åªèƒ½åœ¨åå°é»˜é»˜åœ°è¢«â€œä¸ªæ€§åŒ–â€ï¼Œè€Œæ— æ³•ç›´è§‚åœ°çœ‹åˆ°å’Œç†è§£ä¸ªæ€§åŒ–æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Œé‚£ä¹ˆContext Engineeringçš„ä»·å€¼å°±åªå®ç°äº†ä¸€åŠã€‚æ”¹é€ æç¤ºè¯è¯¦æƒ…é¡µï¼Œè®©ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°ä¸è‡ªå·±ç›¸å…³çš„ä¸Šä¸‹æ–‡å†…å®¹ï¼Œæ˜¯æå‡ç”¨æˆ·ä½“éªŒã€å»ºç«‹ä¿¡ä»»å’Œå‘æŒ¥æ–°æ¶æ„å…¨éƒ¨å¨åŠ›çš„æ ¸å¿ƒä¸¾æªã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ‡å®å¯è¡Œçš„æ”¹é€ æ–¹æ¡ˆï¼ŒåŒ…å«åç«¯APIå’Œå‰ç«¯ç»„ä»¶çš„å®Œæ•´å®ç°ã€‚
æ ¸å¿ƒç›®æ ‡ï¼šæ‰“é€ â€œä¸ºæˆ‘è€Œç”Ÿâ€çš„æç¤ºè¯è¯¦æƒ…é¡µ
å½“ç™»å½•ç”¨æˆ·æŸ¥çœ‹ä¸€ä¸ªæç¤ºè¯æ—¶ï¼Œé¡µé¢ä¸ä»…åº”å±•ç¤ºå…¶é€šç”¨æè¿°ï¼Œè¿˜åº”å¢åŠ ä¸€ä¸ª**â€œæˆ‘çš„ä¸Šä¸‹æ–‡â€æ¨¡å—ï¼Œæ¸…æ™°åœ°å‘Šè¯‰ç”¨æˆ·ï¼šâ€œè¿™ä¸ªæç¤ºè¯å°†ä¼šå¦‚ä½•ä¸ºä½ é‡èº«å®šåˆ¶â€**ã€‚

ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåç«¯APIç«¯ç‚¹
æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„APIç«¯ç‚¹ï¼Œå®ƒèƒ½å®‰å…¨åœ°è·å–ç‰¹å®šç”¨æˆ·ä¸ç‰¹å®šæç¤ºè¯ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
æ–‡ä»¶è·¯å¾„:Â /web/pages/api/prompts/[id]/my-context.tsÂ (è¿™æ˜¯ä¸€ä¸ªæ–°æ–‡ä»¶)
è¿™ä¸ªAPIå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. éªŒè¯ç”¨æˆ·èº«ä»½ã€‚
2. æ ¹æ®Â promptIdÂ å’ŒÂ userIdÂ ä»æ•°æ®åº“ä¸­èšåˆä¿¡æ¯ã€‚
3. æŸ¥è¯¢Â user_context_profilesÂ è·å–ç”¨æˆ·åå¥½ã€‚
4. æŸ¥è¯¢Â promptsÂ è¡¨è·å–æç¤ºè¯è‡ªå¸¦çš„å…¬å…±é€‚åº”è§„åˆ™ã€‚
5. æŸ¥è¯¢Â user_interactionsÂ è¡¨è·å–ç”¨æˆ·ä¸æ­¤æç¤ºè¯çš„æœ€è¿‘äº¤äº’è®°å½•ã€‚
6. è¿”å›ä¸€ä¸ªç»“æ„åŒ–çš„JSONå¯¹è±¡ç»™å‰ç«¯ã€‚
unfold_morenote_addNew file: my-context.ts
+72

content_copy

fullscreen

check

 Show full code block
import { NextApiRequest, NextApiResponse } from 'next';
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs';
import { db } from '../../../../lib/db'; // å‡è®¾è¿™æ˜¯ä½ çš„Prisma/DBå®¢æˆ·ç«¯

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method Not Allowed' });
  }

  const supabase = createServerSupabaseClient({ req, res });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (!session) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  const { id: promptId } = req.query;
  const userId = session.user.id;

  if (typeof promptId !== 'string') {
    return res.status(400).json({ error: 'Invalid prompt ID' });
  }

  try {
    // 1. è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡æ¡£æ¡ˆ
    const userProfile = await db.user_context_profiles.findFirst({
      where: { user_id: userId, is_active: true },
      select: { preferences: true, context_data: true },
    });

    // 2. è·å–æç¤ºè¯çš„å…¬å…±é€‚åº”è§„åˆ™
    const prompt = await db.prompts.findUnique({
      where: { id: promptId },
      select: { adaptation_rules: true },
    });

    // 3. è·å–ç”¨æˆ·ä¸æ­¤æç¤ºè¯çš„æœ€è¿‘5æ¬¡äº¤äº’
    const recentInteractions = await db.user_interactions.findMany({
      where: {
        user_id: userId,
        prompt_id: promptId,
      },
      orderBy: {
        created_at: 'desc',
      },
      take: 5,
      select: {
        created_at: true,
        interaction_data: true, // åŒ…å«è¾“å…¥å’Œè¾“å‡ºçš„JSONB
      },
    });

    const responseData = {
      userPreferences: userProfile?.preferences || {},
      promptRules: prompt?.adaptation_rules || [],
      recentInteractions: recentInteractions.map(interaction => ({
        timestamp: interaction.created_at,
        // å‡è®¾ interaction_data ç»“æ„ä¸º { input: '...', output: '...' }
        input: (interaction.interaction_data as any)?.input,
        output: (interaction.interaction_data as any)?.output,
      })),
    };

    res.status(200).json(responseData);

  } catch (error) {
    console.error(`Error fetching user context for prompt ${promptId}:`, error);
    res.status(500).json({ error: 'Internal Server Error' });
  }
}

ç¬¬äºŒæ­¥ï¼šè®¾è®¡å¹¶å®ç°å‰ç«¯UIç»„ä»¶

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„Reactç»„ä»¶æ¥å±•ç¤ºä»ä¸Šè¿°APIè·å–çš„æ•°æ®ã€‚è¿™ä¸ªç»„ä»¶å°†åªåœ¨ç”¨æˆ·ç™»å½•æ—¶æ˜¾ç¤ºã€‚
æ–‡ä»¶è·¯å¾„:Â /web/components/prompts/UserPromptContext.tsxÂ (è¿™æ˜¯ä¸€ä¸ªæ–°æ–‡ä»¶)
è¿™ä¸ªç»„ä»¶å°†åŒ…å«ä¸€ä¸ªé€‰é¡¹å¡ç•Œé¢ï¼Œä½¿ç”¨æˆ·å¯ä»¥è½»æ¾åœ°åœ¨ä¸åŒç±»å‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹‹é—´åˆ‡æ¢ã€‚
unfold_morenote_addNew file: UserPromptContext.tsx
+110

content_copy

fullscreen

check

 Show full code block
import React, { useState, useEffect } from 'react';
import useSWR from 'swr';

interface UserPromptContextProps {
  promptId: string;
  isLoggedIn: boolean;
}

const fetcher = (url: string) => fetch(url).then((res) => {
  if (!res.ok) {
    if (res.status === 401) return null; // ç”¨æˆ·æœªç™»å½•ï¼Œæ­£å¸¸å¤„ç†
    throw new Error('Failed to fetch user context');
  }
  return res.json();
});

const TABS = ['ä¸ªæ€§åŒ–é¢„è§ˆ', 'æœ€è¿‘äº¤äº’', 'é€‚ç”¨è§„åˆ™'];

export default function UserPromptContext({ promptId, isLoggedIn }: UserPromptContextProps) {
  const { data, error } = useSWR(isLoggedIn ? `/api/prompts/${promptId}/my-context` : null, fetcher);
  const [activeTab, setActiveTab] = useState(TABS[0]);

  if (!isLoggedIn) {
    return null; // æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºæ­¤ç»„ä»¶
  }

  if (error) {
    return <div className="p-4 my-4 border border-red-200 bg-red-50 rounded-md">åŠ è½½æ‚¨çš„ä¸ªæ€§åŒ–ä¿¡æ¯æ—¶å‡ºé”™ã€‚</div>;
  }

  if (!data) {
    return <div className="p-4 my-4 border border-gray-200 bg-gray-50 rounded-md">æ­£åœ¨åŠ è½½æ‚¨çš„ä¸ªæ€§åŒ–ä¿¡æ¯...</div>;
  }

  const renderContent = () => {
    switch (activeTab) {
      case 'ä¸ªæ€§åŒ–é¢„è§ˆ':
        return (
          <div>
            <h4 className="font-semibold">æ‚¨çš„åå¥½è®¾ç½®</h4>
            {Object.keys(data.userPreferences).length > 0 ? (
              <pre className="p-2 mt-2 bg-gray-100 rounded text-sm">
                {JSON.stringify(data.userPreferences, null, 2)}
              </pre>
            ) : (
              <p className="text-sm text-gray-500 mt-2">æ‚¨å°šæœªè®¾ç½®ä¸ªäººåå¥½ã€‚å‰å¾€â€œè´¦æˆ·è®¾ç½®â€è¿›è¡Œé…ç½®ã€‚</p>
            )}
            <p className="text-xs text-gray-600 mt-2">è¿™äº›è®¾ç½®å°†ç”¨äºåŠ¨æ€è°ƒæ•´æç¤ºè¯ï¼Œä»¥æ›´å¥½åœ°æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚</p>
          </div>
        );
      case 'æœ€è¿‘äº¤äº’':
        return (
          <div>
            {data.recentInteractions.length > 0 ? (
              <ul className="space-y-3">
                {data.recentInteractions.map((item: any, index: number) => (
                  <li key={index} className="p-2 border-b border-gray-200">
                    <p className="text-xs text-gray-500">{new Date(item.timestamp).toLocaleString()}</p>
                    <p className="font-mono text-sm truncate"><strong>è¾“å…¥:</strong> {item.input}</p>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-sm text-gray-500">æ‚¨è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡è¿™ä¸ªæç¤ºè¯ã€‚</p>
            )}
          </div>
        );
      case 'é€‚ç”¨è§„åˆ™':
        return (
          <div>
            <h4 className="font-semibold">æç¤ºè¯å†…ç½®è§„åˆ™</h4>
            {data.promptRules.length > 0 ? (
              <pre className="p-2 mt-2 bg-gray-100 rounded text-sm">
                {JSON.stringify(data.promptRules, null, 2)}
              </pre>
            ) : (
              <p className="text-sm text-gray-500">æ­¤æç¤ºè¯æ²¡æœ‰å†…ç½®çš„å…¬å…±é€‚åº”è§„åˆ™ã€‚</p>
            )}
          </div>
        );
      default:
        return null;
    }
  };

  return (
    <div className="my-6 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-sm">
      <h3 className="text-lg font-bold text-blue-800 mb-3">ğŸš€ æˆ‘çš„ä¸Šä¸‹æ–‡</h3>
      <div className="border-b border-gray-300 mb-4">
        <nav className="-mb-px flex space-x-4" aria-label="Tabs">
          {TABS.map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`${
                activeTab === tab
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              } whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`}
            >
              {tab}
            </button>
          ))}
        </nav>
      </div>
      <div>{renderContent()}</div>
    </div>
  );
}

ç¬¬ä¸‰æ­¥ï¼šåœ¨æç¤ºè¯è¯¦æƒ…é¡µä¸­é›†æˆæ–°ç»„ä»¶

æœ€åï¼Œåœ¨ä½ ç°æœ‰çš„æç¤ºè¯è¯¦æƒ…é¡µï¼ˆä¾‹å¦‚Â /web/pages/prompts/[id].tsxï¼‰ä¸­ï¼Œå¯¼å…¥å¹¶ä½¿ç”¨è¿™ä¸ªæ–°ç»„ä»¶ã€‚
unfold_moretsx

content_copy

add

 Show full code block
// åœ¨ä½ çš„æç¤ºè¯è¯¦æƒ…é¡µç»„ä»¶ä¸­ (e.g., /web/pages/prompts/[id].tsx)

import { useUser } from '@supabase/auth-helpers-react';
import UserPromptContext from '../../components/prompts/UserPromptContext';
// ... å…¶ä»–å¯¼å…¥

export default function PromptDetailPage({ prompt }) {
  const user = useUser();

  return (
    <div>
      {/*... ç°æœ‰çš„æç¤ºè¯ä¿¡æ¯å±•ç¤º ...*/}
      <h1>{prompt.name}</h1>
      <p>{prompt.description}</p>

      {/* åœ¨è¿™é‡Œé›†æˆæ–°çš„ä¸Šä¸‹æ–‡ç»„ä»¶ */}
      <UserPromptContext promptId={prompt.id} isLoggedIn={!!user} />

      {/* ... å…¶ä»–é¡µé¢å†…å®¹ï¼Œå¦‚è¯„è®ºåŒºç­‰ ... */}
    </div>
  );
}

æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¸‰æ­¥ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°å°†ä¸€ä¸ªé™æ€çš„æç¤ºè¯è¯¦æƒ…é¡µï¼Œæ”¹é€ æˆäº†ä¸€ä¸ªåŠ¨æ€çš„ã€ä¸ªæ€§åŒ–çš„ã€å¯¹ç”¨æˆ·é€æ˜çš„â€œä¸Šä¸‹æ–‡å·¥ç¨‹â€å±•ç¤ºçª—å£ã€‚
è¿™ä¸ªæ”¹é€ å¸¦æ¥äº†å·¨å¤§çš„å¥½å¤„ï¼š

* æå‡ç”¨æˆ·ä¿¡ä»»ï¼šç”¨æˆ·èƒ½æ¸…æ¥šåœ°çœ‹åˆ°ç³»ç»Ÿå°†å¦‚ä½•åˆ©ç”¨ä»–ä»¬çš„åå¥½ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªâ€œé»‘ç›’â€ã€‚
* å¢å¼ºç”¨æˆ·å‚ä¸åº¦ï¼šé¼“åŠ±ç”¨æˆ·å»å®Œå–„è‡ªå·±çš„ä¸ªæ€§åŒ–é…ç½®ï¼Œä»¥è·å¾—æ›´å¥½çš„ä½“éªŒã€‚
* å±•ç¤ºäº§å“ä»·å€¼ï¼šç›´è§‚åœ°å±•ç¤ºäº†Context Engineeringæ¶æ„çš„å¼ºå¤§èƒ½åŠ›ï¼Œä½¿å…¶ä¸å†ä»…ä»…æ˜¯ä¸€ä¸ªåç«¯æ¦‚å¿µã€‚
* é—­ç¯ä¼˜åŒ–ï¼šç”¨æˆ·çœ‹åˆ°è‡ªå·±çš„äº¤äº’å†å²ï¼Œèƒ½æ›´å¥½åœ°ç†è§£å’Œä¼˜åŒ–æœªæ¥çš„è¾“å…¥ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæç¤ºè¯ç®¡ç†ç•Œé¢æ”¹é€ 

æ­¤é˜¶æ®µä¸“æ³¨äºæ›´æ–°åº”ç”¨æœ€å…³é”®çš„éƒ¨åˆ†ï¼šåˆ›å»ºå’Œç¼–è¾‘æç¤ºè¯ã€‚

1. æç¤ºè¯ç¼–è¾‘å™¨å¤§ä¿®
ç°æœ‰çš„æç¤ºè¯ç¼–è¾‘å™¨ï¼ˆå¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªç®€å•çš„æ–‡æœ¬åŒºåŸŸï¼‰éœ€è¦è¢«ä¸€ä¸ªå¤šåŠŸèƒ½çš„ç»„ä»¶æ‰€å–ä»£ï¼Œè¯¥ç»„ä»¶èƒ½å¤Ÿå¤„ç†æ–°çš„Â contentÂ JSONB ç»“æ„ã€‚
ä½ç½®:Â /prompts/[id]/editÂ é¡µé¢
å»ºè®®çš„UIè®¾è®¡:

* ä¸€ä¸ªÂ â€œå¯ç”¨ä¸Šä¸‹æ–‡å·¥ç¨‹â€Â çš„åˆ‡æ¢å¼€å…³ã€‚
  * å…³é—­æ—¶: æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„Markdownç¼–è¾‘å™¨ï¼Œç”¨äºç¼–è¾‘Â simple_textÂ æˆ–Â legacy_textÂ å†…å®¹ï¼Œç¡®ä¿å‘åå…¼å®¹ã€‚
  * å¼€å¯æ—¶: æ˜¾ç¤ºä¸€ä¸ªé€‰é¡¹å¡å¼ç•Œé¢ï¼Œç”¨äºæ„å»ºÂ PromptContentJsonbÂ å¯¹è±¡ã€‚
* ä¸Šä¸‹æ–‡å·¥ç¨‹çš„é€‰é¡¹å¡å¼ç•Œé¢:
    1. é™æ€å†…å®¹ (Static Content): ä¸€ä¸ªå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œç”¨äºÂ static_contentÂ å­—æ®µã€‚è¿™æ˜¯æç¤ºè¯çš„åŸºç¡€æ¨¡æ¿ã€‚
    2. åŠ¨æ€ä¸Šä¸‹æ–‡ (Dynamic Context): ä¸€ä¸ªç”¨äºé…ç½®Â dynamic_contextÂ å¯¹è±¡çš„åŒºåŸŸã€‚
        * ç¤ºä¾‹ (Examples): ä¸€ä¸ªç”¨äºæ·»åŠ ã€ç¼–è¾‘å’Œé‡æ–°æ’åº few-shot ç¤ºä¾‹ï¼ˆè¾“å…¥/è¾“å‡ºå¯¹ï¼‰çš„UIã€‚è¿™å°†ç®¡ç†Â example_poolã€‚
        * å·¥å…· (Tools): ä¸€ä¸ªå¤šé€‰ä¸‹æ‹‰èœå•ï¼Œç”¨äºé“¾æ¥å¯ç”¨çš„å·¥å…·ï¼ˆå¦‚æœå­˜åœ¨å·¥å…·æ³¨å†Œè¡¨ï¼‰ã€‚
        * é€‚åº”è§„åˆ™ (Adaptation Rules): è¿™æ˜¯ä¸€ä¸ªå…³é”®åŠŸèƒ½ã€‚
            * åˆæ­¥å®ç°: ä¸€ä¸ªå¸¦schemaéªŒè¯çš„JSONç¼–è¾‘å™¨ï¼ˆå¦‚Â react-json-editor-ajrmï¼‰ï¼Œå¸®åŠ©ç”¨æˆ·ç¼–å†™æ­£ç¡®çš„è§„åˆ™ç»“æ„ã€‚
            * æœªæ¥å¢å¼º: ä¸€ä¸ªå¯è§†åŒ–çš„è§„åˆ™æ„å»ºå™¨ï¼šå¦‚æœ [ä¸Šä¸‹æ–‡å˜é‡] [æ“ä½œç¬¦] [å€¼] åˆ™ [æ‰§è¡ŒåŠ¨ä½œ]ã€‚
    3. å˜é‡ (Variables): ä¸€ä¸ªä¸“é—¨çš„UIï¼Œç”¨äºå®šä¹‰Â input_variablesï¼ŒåŒ…å«åç§°ã€æè¿°å’Œç±»å‹ï¼Œæ¯”ç®€å•çš„æ–‡æœ¬å­—æ®µæ›´æ¸…æ™°ã€‚
    4. è®¾ç½® (Settings): ä¸€ä¸ªç”¨äºå¡«å†™å…ƒæ•°æ®ï¼ˆå¦‚Â version,Â is_public,Â compatible_modelsÂ ç­‰ï¼‰çš„è¡¨å•ã€‚

2. æ–°ç»„ä»¶:Â ContextualPromptEditor.tsx
ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œéœ€è¦ä¸€ä¸ªæ–°çš„ã€å¤æ‚çš„ç»„ä»¶ã€‚
unfold_morenote_addNew file: ContextualPromptEditor.tsx

 Show full code block
import React, { useState } from 'react';
import { Prompt, PromptContentJsonb } from '../../lib/types'; // å‡è®¾ç±»å‹æ˜¯å…±äº«çš„

// å¯¼å…¥æ¯ä¸ªé€‰é¡¹å¡çš„å­ç»„ä»¶
import StaticContentEditor from './editors/StaticContentEditor';
import DynamicContextEditor from './editors/DynamicContextEditor';
import VariablesEditor from './editors/VariablesEditor';
import PromptSettingsEditor from './editors/PromptSettingsEditor';

interface Props {
  prompt: Prompt;
  onSave: (updatedPrompt: Partial<Prompt>) => void;
}

const TABS = ['é™æ€å†…å®¹', 'åŠ¨æ€ä¸Šä¸‹æ–‡', 'å˜é‡', 'è®¾ç½®'];

export default function ContextualPromptEditor({ prompt, onSave }: Props) {
  const [isCeEnabled, setIsCeEnabled] = useState(prompt.context_engineering_enabled || false);
  const [activeTab, setActiveTab] = useState(TABS[0]);
  const [content, setContent] = useState<PromptContentJsonb | string>(prompt.content);

  const handleToggleCe = (enabled: boolean) => {
    setIsCeEnabled(enabled);
    if (enabled) {
      // åˆ‡æ¢æ—¶å°†å­—ç¬¦ä¸²å†…å®¹è½¬æ¢ä¸ºJSONBç»“æ„
      if (typeof content === 'string') {
        setContent({
          type: 'context_engineering',
          static_content: content,
          dynamic_context: {},
          fallback_content: content,
        });
      }
    } else {
      // è½¬æ¢å›çº¯æ–‡æœ¬
      setContent(
        (typeof content === 'object' && content.static_content) || ''
      );
    }
  };

  const handleSave = () => {
    onSave({
      ...prompt,
      content,
      context_engineering_enabled: isCeEnabled,
    });
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <h2>ç¼–è¾‘æç¤ºè¯</h2>
        <div>
          <label>å¯ç”¨ä¸Šä¸‹æ–‡å·¥ç¨‹</label>
          <input type="checkbox" checked={isCeEnabled} onChange={(e) => handleToggleCe(e.target.checked)} />
        </div>
      </div>

      {isCeEnabled ? (
        <div>
          <div className="tabs">
            {TABS.map(tab => <button key={tab} onClick={() => setActiveTab(tab)}>{tab}</button>)}
          </div>
          {activeTab === 'é™æ€å†…å®¹' && <StaticContentEditor />}
          {activeTab === 'åŠ¨æ€ä¸Šä¸‹æ–‡' && <DynamicContextEditor />}
          {/* ... å…¶ä»–é€‰é¡¹å¡ */}
        </div>
      ) : (
        <textarea value={typeof content === 'string' ? content : ''} /* ... */ />
      )}
      <button onClick={handleSave}>ä¿å­˜æç¤ºè¯</button>
    </div>
  );
}

### ç¬¬ä¸‰é˜¶æ®µï¼šç”¨æˆ·ä¸ªæ€§åŒ–ä¸å†å²è®°å½•

æ­¤é˜¶æ®µå¼•å…¥æ–°é¡µé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥æ§åˆ¶è‡ªå·±çš„ä½“éªŒå¹¶å›é¡¾ä»–ä»¬çš„æ´»åŠ¨ï¼Œè¿™å……åˆ†åˆ©ç”¨äº†æ–°çš„ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„è¡¨ã€‚

1. ç”¨æˆ·ä¸ªæ€§åŒ–ä¸­å¿ƒ
ä¸€ä¸ªæ–°é¡µé¢ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œç®¡ç†ä»–ä»¬çš„Â user_context_profilesã€‚
ä½ç½®:Â /account/personalization
å»ºè®®çš„UIè®¾è®¡:

* ç”¨æˆ·åå¥½ (User Preferences): ä¸€ä¸ªè¡¨å•ï¼Œç”¨äºè®¾ç½®ä»–ä»¬ä¸Šä¸‹æ–‡çš„é”®å€¼å¯¹ï¼ˆä¾‹å¦‚Â language: 'zh-CN',Â style: 'formal'ï¼‰ã€‚è¿™å¯¹åº”äºÂ user_context_profilesÂ è¡¨ä¸­çš„Â preferencesÂ JSONB å­—æ®µã€‚
* æˆ‘çš„é€‚åº”è§„åˆ™ (My Adaptation Rules): ä¸€ä¸ªæŸ¥çœ‹å’Œç®¡ç†ä¸ªäººé€‚åº”è§„åˆ™çš„è§†å›¾ã€‚è¿™ä¸ºç”¨æˆ·æä¾›äº†å¯¹æç¤ºè¯å¦‚ä½•é€‚åº”ä»–ä»¬çš„ç²¾ç»†æ§åˆ¶ã€‚
* å­¦ä¹ åˆ°çš„æ¨¡å¼ (Learned Patterns - é€æ˜åº¦): ä¸€ä¸ªåªè¯»è§†å›¾ï¼Œæ˜¾ç¤ºä»–ä»¬çš„Â usagePatternsÂ å’ŒÂ contextualMemoryï¼ˆæ¥è‡ªÂ context-manager.tsÂ çš„é€»è¾‘ï¼‰ã€‚é€šè¿‡å‘ç”¨æˆ·å±•ç¤ºç³»ç»Ÿå­¦ä¹ åˆ°çš„å…³äºä»–ä»¬çš„ä¿¡æ¯æ¥å»ºç«‹ä¿¡ä»»ã€‚
* éšç§æ§åˆ¶ (Privacy Controls): ä¸€ä¸ªæ¸…æ™°çš„Â allowAnonymousAnalyticsÂ åˆ‡æ¢å¼€å…³ï¼Œä»¥åŠä¸€ä¸ªç”¨äºå¯¼å‡ºæˆ–åˆ é™¤å…¶æ•°æ®çš„æŒ‰é’®ï¼Œä»¥ç¬¦åˆGDPRåŸåˆ™ã€‚

2. ä¼šè¯å†å²æŸ¥çœ‹å™¨
ä¸€ä¸ªç”¨äºæŸ¥çœ‹äº¤äº’å†å²çš„æ–°é¡µé¢ã€‚
ä½ç½®:Â /account/history
å»ºè®®çš„UIè®¾è®¡:

* ä¸€ä¸ªåˆ—å‡ºæ‰€æœ‰Â context_sessionsÂ çš„åˆ—è¡¨ã€‚
* æ¯ä¸ªä¼šè¯éƒ½å¯ä»¥å±•å¼€ï¼Œä»¥æ˜¾ç¤ºè¯¥ä¼šè¯ä¸­Â user_interactionsÂ çš„æ—¶é—´çº¿ã€‚
* å¯¹äºæ¯æ¬¡äº¤äº’ï¼Œæ˜¾ç¤ºè¾“å…¥ã€æœ€ç»ˆé€‚åº”åçš„æç¤ºè¯ä»¥åŠæ¨¡å‹çš„å“åº”ã€‚è¿™å¯¹äºè°ƒè¯•å’Œç†è§£ä¸ºä»€ä¹ˆä¼šç”ŸæˆæŸä¸ªç‰¹å®šå“åº”éå¸¸æœ‰ä»·å€¼ã€‚

### ç¬¬å››é˜¶æ®µï¼šç®¡ç†å‘˜ä¸é«˜çº§åŠŸèƒ½

æ­¤é˜¶æ®µä¸ºç®¡ç†å‘˜å’Œé«˜çº§ç”¨æˆ·æ„å»ºé«˜å±‚çº§çš„ç®¡ç†å’Œåˆ†æå·¥å…·ã€‚

1. å®éªŒå¹³å°
åœ¨ç®¡ç†å‘˜ä»ªè¡¨ç›˜ä¸­å¢åŠ ä¸€ä¸ªæ–°éƒ¨åˆ†æ¥ç®¡ç†A/Bæµ‹è¯•ã€‚
ä½ç½®:Â /admin/experiments
å»ºè®®çš„UIè®¾è®¡:

* ä»ªè¡¨ç›˜: ä¸€ä¸ªåˆ—å‡ºæ‰€æœ‰å®éªŒçš„è¡¨æ ¼ï¼Œç”±Â context_experimentsÂ è¡¨å’ŒÂ experiment_analyticsÂ è§†å›¾æä¾›æ”¯æŒã€‚æ˜¾ç¤ºçŠ¶æ€ã€å‚ä¸è€…æ•°é‡ã€å®Œæˆç‡ç­‰ã€‚
* å®éªŒåˆ›å»º/ç¼–è¾‘å™¨: ä¸€ä¸ªå¤šæ­¥éª¤å‘å¯¼ï¼Œç”¨äºåˆ›å»ºæ–°å®éªŒã€‚
    1. å®šä¹‰åç§°ã€æè¿°å’Œå‡è®¾ã€‚
    2. é€‰æ‹©å®éªŒç±»å‹ï¼ˆä¾‹å¦‚ï¼Œå¯¹æŸä¸ªæç¤ºè¯è¿›è¡ŒA/Bæµ‹è¯•ï¼‰ã€‚
    3. é…ç½®å˜ä½“ï¼ˆä¾‹å¦‚ï¼Œå˜ä½“Aä½¿ç”¨ä¸€å¥—é€‚åº”è§„åˆ™ï¼Œå˜ä½“Bä½¿ç”¨å¦ä¸€å¥—ï¼‰ã€‚
    4. è®¾ç½®å—ä¼—/ç›®æ ‡è§„åˆ™ã€‚
    5. å®‰æ’å¼€å§‹å’Œç»“æŸæ—¥æœŸã€‚
* ç»“æœé¡µé¢: å¯¹äºæ¯ä¸ªå®Œæˆçš„å®éªŒï¼Œæ˜¾ç¤ºå›¾è¡¨å’ŒæŒ‡æ ‡ï¼Œæ¯”è¾ƒæ¯ä¸ªå˜ä½“çš„æ€§èƒ½ã€‚

2. åˆ†æä¸å¥åº·ä»ªè¡¨ç›˜
åœ¨ç®¡ç†åŒºåŸŸåˆ›å»ºæ–°é¡µé¢ï¼Œä»¥å¯è§†åŒ–æ–°æ•°æ®åº“è§†å›¾ä¸­çš„æ•°æ®ã€‚
ä½ç½®:Â /admin/analytics
å»ºè®®çš„UIè®¾è®¡:

* ç³»ç»Ÿå¥åº· (System Health): å¯è§†åŒ–æ¥è‡ªÂ context_engineering_healthÂ çš„æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ´»åŠ¨ä¼šè¯æ•°ã€ç¼“å­˜å‘½ä¸­ç‡ï¼‰ã€‚
* æç¤ºè¯æ€§èƒ½ (Prompt Performance): ä¸€ä¸ªå¯æœç´¢ã€å¯æ’åºçš„è¡¨æ ¼ï¼Œåˆ—å‡ºæ‰€æœ‰æç¤ºè¯ï¼Œä½¿ç”¨Â prompt_performance_analysisÂ è§†å›¾ï¼Œæ˜¾ç¤ºä½¿ç”¨æ¬¡æ•°ã€æ»¡æ„åº¦åˆ†æ•°å’Œå“åº”æ—¶é—´ã€‚
* æç¤ºè¯ä¾èµ–å›¾ (Prompt Dependency Graph): ä½¿ç”¨åƒÂ react-flowÂ æˆ–Â vis.jsÂ è¿™æ ·çš„åº“æ¥æ¸²æŸ“Â prompt_dependency_graphÂ è§†å›¾çš„è¾“å‡ºã€‚è¿™å°†æ˜¯ç†è§£å¤æ‚æç¤ºè¯é“¾çš„å¼ºå¤§å·¥å…·ã€‚
åç«¯APIæ”¹é€  (WebæœåŠ¡å™¨)
çš„WebæœåŠ¡å™¨å°†éœ€è¦æ–°çš„APIç«¯ç‚¹æ¥æ”¯æŒè¿™äº›å‰ç«¯æ›´æ”¹ã€‚
unfold_morenote_addNew file: [...slug].ts

 Show full code block
// WebæœåŠ¡å™¨æ–°APIè·¯ç”±ç»“æ„çš„ç¤ºä¾‹
// ç”¨äºå¤„ç†ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†åŠŸèƒ½ã€‚

import { NextApiRequest, NextApiResponse } from 'next';
import { db } from '../../../lib/db'; // çš„æ•°æ®åº“å®¢æˆ·ç«¯
import { auth } from '../../../lib/auth'; // çš„è®¤è¯ä¸­é—´ä»¶

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { userId } = await auth(req, res);
  if (!userId) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  const { slug } = req.query;
  const action = slug[0];

  try {
    switch (`${req.method} /${action}`) {
      // GET /api/context-engineering/preferences
      case 'GET /preferences':
        // ä» user_context_profiles è·å–æ•°æ®çš„é€»è¾‘
        const profile = await db.user_context_profiles.findUnique({ where: { user_id: userId }});
        res.status(200).json(profile?.preferences || {});
        break;

      // POST /api/context-engineering/preferences
      case 'POST /preferences':
        // æ›´æ–° user_context_profiles çš„é€»è¾‘
        const { preferences } = req.body;
        const updatedProfile = await db.user_context_profiles.upsert({
            where: { user_id: userId },
            update: { preferences },
            create: { user_id: userId, profile_name: 'default', preferences, context_data: {} }
        });
        res.status(200).json(updatedProfile);
        break;

      // æ·»åŠ  adaptation-rules, experiments ç­‰æƒ…å†µçš„å¤„ç†
      // ç®¡ç†å‘˜ä¸“ç”¨è·¯ç”±ç¤ºä¾‹:
      // GET /api/context-engineering/experiments
      case 'GET /experiments':
        // åœ¨æ­¤å¤„æ·»åŠ ç®¡ç†å‘˜è§’è‰²æ£€æŸ¥
        const experiments = await db.context_experiments.findMany();
        res.status(200).json(experiments);
        break;

      default:
        res.status(404).json({ error: 'Not Found' });
    }
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error' });
  }
}

### æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªåˆ†é˜¶æ®µçš„ã€ç¨³å¥çš„è·¯å¾„ï¼Œå¯ä»¥å°†å¼ºå¤§çš„æ–°ä¸Šä¸‹æ–‡å·¥ç¨‹åç«¯çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé›†æˆåˆ°ä¸€ä¸ªç”¨æˆ·å‹å¥½ä¸”åŠŸèƒ½å¼ºå¤§çš„Webåº”ç”¨ç¨‹åºä¸­ã€‚
è¯·æŒ‰ç…§è¿™ä¸ªæ–¹æ¡ˆæ”¹é€ webæœåŠ¡å™¨ï¼Œæ³¨æ„ï¼Œè¯·å‘æŒ¥ä½ çš„æƒ³è±¡åŠ›å’Œæ‰èƒ½ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„æ–¹æ¡ˆå’Œæƒ³æ³•ï¼Œä½ å¯ä»¥ä¸»åŠ¨ä¿®æ”¹æˆ‘çš„æ–¹æ¡ˆï¼Œæ— éœ€ç»è¿‡æˆ‘çš„åŒæ„
