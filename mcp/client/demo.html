<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Prompt Server 演示</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f7f9fc;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
      background-color: #f5f5f5;
    }
    .tab.active {
      background-color: white;
      border-color: #ddd;
      border-bottom-color: white;
      margin-bottom: -1px;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result-area {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    .prompt-item {
      margin-bottom: 10px;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      border-left: 3px solid #4CAF50;
    }
    .prompt-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .prompt-desc {
      color: #666;
      margin-bottom: 5px;
    }
    .prompt-meta {
      font-size: 0.8em;
      color: #999;
    }
    .prompt-content {
      margin-top: 10px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    .ai-chat {
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
      max-width: 80%;
    }
    .user-message {
      background-color: #DCF8C6;
      align-self: flex-end;
      margin-left: auto;
    }
    .ai-message {
      background-color: white;
      align-self: flex-start;
    }
    .chat-input {
      display: flex;
    }
    .chat-input textarea {
      flex: 1;
      margin-right: 10px;
    }
    .settings-form {
      max-width: 600px;
    }
    .error {
      color: #D32F2F;
      background-color: #FFEBEE;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .success {
      color: #388E3C;
      background-color: #E8F5E9;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MCP Prompt Server 演示</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="search">搜索提示词</div>
      <div class="tab" data-tab="save">保存提示词</div>
      <div class="tab" data-tab="chat">AI对话演示</div>
      <div class="tab" data-tab="settings">设置</div>
    </div>
    
    <div class="tab-content active" id="search-tab">
      <div class="form-group">
        <label for="search-query">搜索关键词:</label>
        <input type="text" id="search-query" placeholder="输入关键词搜索提示词">
      </div>
      
      <button id="search-btn">搜索</button>
      
      <div class="result-area" id="search-results">
        <p>搜索结果将显示在这里...</p>
      </div>
    </div>
    
    <div class="tab-content" id="save-tab">
      <div class="form-group">
        <label for="prompt-name">提示词名称:</label>
        <input type="text" id="prompt-name" placeholder="输入提示词名称">
      </div>
      
      <div class="form-group">
        <label for="prompt-content">提示词内容:</label>
        <textarea id="prompt-content" placeholder="输入提示词内容"></textarea>
      </div>
      
      <div class="form-group">
        <label for="prompt-description">描述 (可选):</label>
        <input type="text" id="prompt-description" placeholder="输入提示词描述">
      </div>
      
      <div class="form-group">
        <label for="prompt-category">分类 (可选):</label>
        <input type="text" id="prompt-category" placeholder="输入提示词分类" value="General">
      </div>
      
      <div class="form-group">
        <label for="prompt-tags">标签 (可选，用逗号分隔):</label>
        <input type="text" id="prompt-tags" placeholder="输入标签，用逗号分隔">
      </div>
      
      <button id="save-btn">保存</button>
      
      <div class="result-area" id="save-result"></div>
    </div>
    
    <div class="tab-content" id="chat-tab">
      <div class="ai-chat">
        <div class="chat-messages" id="chat-messages">
          <div class="message ai-message">
            您好！我是您的AI助手。您可以:
            <ul>
              <li>输入 "搜索提示词: [关键词]" 来搜索提示词</li>
              <li>输入 "保存提示词: [名称]: [内容]" 来保存提示词</li>
              <li>输入 "使用提示词: [名称]" 来使用特定提示词</li>
            </ul>
            请问有什么可以帮助您的？
          </div>
        </div>
        
        <div class="chat-input">
          <textarea id="user-input" placeholder="输入消息..."></textarea>
          <button id="send-btn">发送</button>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="settings-tab">
      <div class="settings-form">
        <div class="form-group">
          <label for="server-url">服务器URL:</label>
          <input type="text" id="server-url" value="http://localhost:9010">
        </div>
        
        <div class="form-group">
          <label for="api-key">API密钥:</label>
          <input type="text" id="api-key" value="your-api-key">
        </div>
        
        <button id="save-settings-btn">保存设置</button>
        
        <div class="result-area" id="settings-result"></div>
      </div>
    </div>
  </div>
  
  <!-- 引入客户端库 -->
  <script src="mcp-prompt-client.js"></script>
  
  <script>
    // 全局变量
    let client = new MCPPromptClient(
      localStorage.getItem('serverUrl') || 'http://localhost:9010',
      localStorage.getItem('apiKey') || 'your-api-key'
    );
    const parser = new PromptCommandParser();
    let promptHandler;
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化设置
      document.getElementById('server-url').value = localStorage.getItem('serverUrl') || 'http://localhost:9010';
      document.getElementById('api-key').value = localStorage.getItem('apiKey') || 'your-api-key';
      
      // 初始化提示词处理器
      initPromptHandler();
      
      // 标签切换
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
      
      // 搜索提示词
      document.getElementById('search-btn').addEventListener('click', searchPrompts);
      document.getElementById('search-query').addEventListener('keypress', e => {
        if (e.key === 'Enter') searchPrompts();
      });
      
      // 保存提示词
      document.getElementById('save-btn').addEventListener('click', savePrompt);
      
      // 设置
      document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
      
      // 聊天
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      document.getElementById('user-input').addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });
    
    // 初始化提示词处理器
    function initPromptHandler() {
      promptHandler = new AIToolPromptHandler(client, parser, {
        onMessage: message => {
          addMessage('ai', message);
        },
        onError: error => {
          addMessage('ai', `错误: ${error}`);
        },
        onInsertPrompt: text => {
          document.getElementById('user-input').value = text;
        },
        onRequestInput: () => {
          return new Promise(resolve => {
            // 创建一个简单的弹窗获取输入
            const input = prompt('请输入:');
            resolve(input || '');
          });
        }
      });
    }
    
    // 搜索提示词
    async function searchPrompts() {
      const query = document.getElementById('search-query').value.trim();
      if (!query) {
        showSearchResult('<p class="error">请输入搜索关键词</p>');
        return;
      }
      
      try {
        showSearchResult('<p>正在搜索...</p>');
        
        const prompts = await client.searchPrompts(query);
        
        if (prompts.length === 0) {
          showSearchResult('<p>没有找到匹配的提示词</p>');
          return;
        }
        
        let html = '';
        prompts.forEach(prompt => {
          html += `
            <div class="prompt-item">
              <div class="prompt-name">${prompt.name}</div>
              <div class="prompt-desc">${prompt.description}</div>
              <div class="prompt-meta">
                分类: ${prompt.category} | 
                标签: ${prompt.tags.join(', ')}
              </div>
              <button class="use-prompt-btn" data-name="${prompt.name}">使用此提示词</button>
              <div class="prompt-content">${getPromptContent(prompt)}</div>
            </div>
          `;
        });
        
        showSearchResult(html);
        
        // 绑定使用提示词按钮事件
        document.querySelectorAll('.use-prompt-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const name = btn.dataset.name;
            try {
              const prompt = await client.getPrompt(name);
              
              if (prompt) {
                document.querySelector('.tab[data-tab="chat"]').click();
                document.getElementById('user-input').value = getPromptContent(prompt);
              }
            } catch (error) {
              showSearchResult(`<p class="error">获取提示词失败: ${error.message}</p>`);
            }
          });
        });
      } catch (error) {
        showSearchResult(`<p class="error">搜索失败: ${error.message}</p>`);
      }
    }
    
    // 获取提示词内容
    function getPromptContent(prompt) {
      if (!prompt.messages || prompt.messages.length === 0) {
        return '提示词内容为空';
      }
      
      return prompt.messages
        .map(msg => {
          if (msg.content && typeof msg.content === 'object' && msg.content.text) {
            return msg.content.text;
          } else if (typeof msg.content === 'string') {
            return msg.content;
          }
          return '';
        })
        .filter(text => text)
        .join('\n\n');
    }
    
    // 显示搜索结果
    function showSearchResult(html) {
      document.getElementById('search-results').innerHTML = html;
    }
    
    // 保存提示词
    async function savePrompt() {
      const name = document.getElementById('prompt-name').value.trim();
      const content = document.getElementById('prompt-content').value.trim();
      const description = document.getElementById('prompt-description').value.trim();
      const category = document.getElementById('prompt-category').value.trim();
      const tagsInput = document.getElementById('prompt-tags').value.trim();
      const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(Boolean) : [];
      
      if (!name) {
        document.getElementById('save-result').innerHTML = '<p class="error">请输入提示词名称</p>';
        return;
      }
      
      if (!content) {
        document.getElementById('save-result').innerHTML = '<p class="error">请输入提示词内容</p>';
        return;
      }
      
      try {
        document.getElementById('save-result').innerHTML = '<p>正在保存...</p>';
        
        await client.createPromptFromText(name, content, description, category, tags);
        
        document.getElementById('save-result').innerHTML = `<p class="success">提示词"${name}"已成功保存</p>`;
        
        // 清空表单
        document.getElementById('prompt-name').value = '';
        document.getElementById('prompt-content').value = '';
        document.getElementById('prompt-description').value = '';
        document.getElementById('prompt-category').value = 'General';
        document.getElementById('prompt-tags').value = '';
      } catch (error) {
        document.getElementById('save-result').innerHTML = `<p class="error">保存失败: ${error.message}</p>`;
      }
    }
    
    // 保存设置
    function saveSettings() {
      const serverUrl = document.getElementById('server-url').value.trim();
      const apiKey = document.getElementById('api-key').value.trim();
      
      if (!serverUrl) {
        document.getElementById('settings-result').innerHTML = '<p class="error">请输入服务器URL</p>';
        return;
      }
      
      if (!apiKey) {
        document.getElementById('settings-result').innerHTML = '<p class="error">请输入API密钥</p>';
        return;
      }
      
      localStorage.setItem('serverUrl', serverUrl);
      localStorage.setItem('apiKey', apiKey);
      
      // 更新客户端
      client = new MCPPromptClient(serverUrl, apiKey);
      initPromptHandler();
      
      document.getElementById('settings-result').innerHTML = '<p class="success">设置已保存</p>';
    }
    
    // 发送聊天消息
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // 添加用户消息
      addMessage('user', message);
      
      // 清空输入框
      input.value = '';
      
      // 处理命令
      const isCommand = await promptHandler.handleInput(message);
      
      // 如果不是命令，则回复一个默认消息
      if (!isCommand) {
        setTimeout(() => {
          addMessage('ai', '我理解您的消息，但这不是一个提示词相关的命令。您可以：\n\n' +
            '- 输入 "搜索提示词: [关键词]" 来搜索提示词\n' +
            '- 输入 "保存提示词: [名称]: [内容]" 来保存提示词\n' +
            '- 输入 "使用提示词: [名称]" 来使用特定提示词');
        }, 500);
      }
    }
    
    // 添加聊天消息
    function addMessage(type, content) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      
      messageElement.className = `message ${type}-message`;
      messageElement.textContent = content;
      
      messagesContainer.appendChild(messageElement);
      
      // 滚动到底部
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  </script>
</body>
</html>
