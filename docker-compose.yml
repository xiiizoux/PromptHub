services:
  # PromptHub main application (Web + MCP)
  prompthub:
    # Explicitly declare environment variable file to ensure Docker Compose reads it correctly
    env_file:
      - .env
    # Provide more consistent build/run behavior for Debian hosts
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time Supabase environment variables
        # Note: These variables must be read from .env file
        # If variables are not set, Dockerfile validation will provide clear error messages
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
        SUPABASE_URL: ${SUPABASE_URL}
    image: prompthub:latest
    pull_policy: build
    container_name: prompthub
    ports:
      - "9010:9010"  # MCP service port
      - "9011:9011"  # Web service port
    environment:
      # Basic environment configuration
      - NODE_ENV=production
      - PORT=9010
      - FRONTEND_PORT=9011
      - TRANSPORT_TYPE=sse
      - NODE_OPTIONS=--max-old-space-size=4096  # Reserve more memory for UI libraries
      
      # Storage configuration - default to supabase
      # Optional values: supabase (file, postgresql, mysql support reserved)
      - STORAGE_TYPE=${STORAGE_TYPE:-supabase}
      
      # Path configuration when using file storage
      - STORAGE_PATH=${STORAGE_PATH:-./data}
      
      # Supabase configuration
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      - NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY=${NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY:-}
      - JWT_SECRET=${JWT_SECRET:-}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-}
      
      # API key configuration
      - API_KEY=${API_KEY:-default-api-key-for-docker}
      - SERVER_KEY=${SERVER_KEY:-default-server-key-for-docker}
    volumes:
      # Persistent data storage
      - ./data:/app/mcp/data  # File storage data directory
      - ./logs:/app/logs      # Log directory
      
      # Configuration file mount (read-only mode)
      - ./.env:/app/.env:ro
    restart: unless-stopped
    # Improve log management to avoid infinite log growth on Debian
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    # Memory limit configuration - supports heavy UI application build and run
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9010/api/health", "&&", "curl", "-f", "http://localhost:9011/api/health"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 40s
    # Allow container to access host network services (common on Debian/Linux)
    extra_hosts:
      - "host.docker.internal:host-gateway"
