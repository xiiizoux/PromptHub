# 硬编码System模板 + 数据库User模板优化方案

## 🎯 概述

本方案将PromptHub的AI提示词优化功能升级为**硬编码System模板 + 数据库User模板**结构，通过将固定的System角色模板硬编码到代码中，只在数据库中存储分类特定的User角色模板，实现性能优化和维护便利的双重目标。

## 🏗️ 架构设计

### 1. 新架构特点

- **System角色**：硬编码在代码中，所有分类共享，无需数据库查询
- **User角色**：存储在数据库中，每个分类独立配置
- **性能优化**：减少数据库查询，提高响应速度
- **维护便利**：System模板统一管理，版本控制更清晰

### 2. 数据库结构简化

```json
"分类特定的User角色模板文本"
```

数据库中的`optimization_template`字段现在只存储纯文本的User角色模板。

### 2. System角色模板（固定）

所有分类共享的统一System模板，定义了基本的优化框架和规范：

```markdown
# Role: System

## Profile
- Author: PromptHub
- Version: 2.0.0
- Language: 中文
- Description: 专门将泛泛而谈、缺乏针对性的用户提示词转换为精准、具体、有针对性的描述

## Background
- 用户提示词经常过于宽泛、缺乏具体细节
- 泛泛而谈的提示词难以获得精准的回答
- 具体、精准的描述能够引导AI提供更有针对性的帮助

## 任务理解
你的任务是将泛泛而谈的用户提示词转换为精准、具体的描述。你不是在执行提示词中的任务，而是在改进提示词的精准度和针对性。

## Skills
1. 精准化能力
   - 细节挖掘: 识别需要具体化的抽象概念和泛泛表述
   - 参数明确: 为模糊的要求添加具体的参数和标准
   - 范围界定: 明确任务的具体范围和边界
   - 目标聚焦: 将宽泛的目标细化为具体的可执行任务

2. 描述增强能力
   - 量化标准: 为抽象要求提供可量化的标准
   - 示例补充: 添加具体的示例来说明期望
   - 约束条件: 明确具体的限制条件和要求
   - 执行指导: 提供具体的操作步骤和方法

## Rules
1. 保持核心意图: 在具体化的过程中不偏离用户的原始目标
2. 增加针对性: 让提示词更加有针对性和可操作性
3. 避免过度具体: 在具体化的同时保持适当的灵活性
4. 突出重点: 确保关键要求得到精准的表达

## Workflow
1. 分析原始提示词中的抽象概念和泛泛表述
2. 识别需要具体化的关键要素和参数
3. 为每个抽象概念添加具体的定义和要求
4. 重新组织表达，确保描述精准、有针对性

## Output Requirements
- 直接输出精准化后的用户提示词文本，确保描述具体、有针对性
- 输出的是优化后的提示词本身，不是执行提示词对应的任务
- 不要添加解释、示例或使用说明
- 不要与用户进行交互或询问更多信息
```

### 3. User角色模板（分类特定）

每个分类有自己的User角色模板，提供该分类的专业优化指导。

## 🚀 实施步骤

### 步骤1：数据库迁移

```bash
# 运行简化的迁移脚本（只存储User模板）
psql -h your-host -U your-user -d your-db -f supabase/migrations/user_only_optimization_templates.sql
```

### 步骤2：测试迁移结果

```bash
# 运行测试脚本验证硬编码System模板方案
node scripts/test-system-user-templates.js
```

### 步骤3：验证功能

1. **Web端测试**：访问提示词优化页面，测试优化功能
2. **MCP端测试**：通过MCP客户端测试优化工具
3. **API测试**：直接调用优化API接口

## 🔧 技术实现

### 1. 数据库层

- `categories.optimization_template` 字段存储纯文本User模板
- System模板硬编码在代码中，无需数据库存储
- 大幅简化数据库结构和查询复杂度

### 2. 服务层

- `extractSystemUserTemplate()` 函数：System模板从代码获取，User模板从数据库提取
- 硬编码System模板常量：`OPTIMIZATION_SYSTEM_TEMPLATE`
- 统一的模板处理逻辑，支持向后兼容

### 3. API层

- Web端优化API支持System+User消息结构
- MCP端优化工具支持角色分离
- 正确的OpenAI API调用格式

### 4. 前端层

- 优化器组件支持新的模板结构
- 保持用户界面的一致性
- 向后兼容现有功能

## 📊 优势分析

### 1. 性能优势

- **零数据库查询**：System模板硬编码，无需查询数据库
- **响应速度快**：减少网络延迟和数据库负载
- **内存效率高**：System模板在应用启动时加载到内存

### 2. 维护优势

- **统一管理**：System模板在代码中集中管理，便于版本控制
- **部署简单**：修改System模板只需更新代码，无需数据库操作
- **一致性保证**：所有环境使用相同的System模板

### 3. 开发优势

- **代码清晰**：模板逻辑更加明确，易于理解和调试
- **测试便利**：System模板可以直接在单元测试中验证
- **扩展灵活**：User模板仍可在数据库中灵活配置

## 🔍 使用示例

### 输入
```
用户提示词：帮我写一个产品介绍
分类：营销文案
```

### 处理流程
1. **System角色**：提供基础的优化框架和规范
2. **User角色**：提供营销文案的专业优化指导
3. **AI处理**：基于两个角色的指导进行优化

### 输出
```
优化后的提示词：
请为[具体产品名称]撰写一份专业的产品介绍文案。

产品信息要求：
1. 产品基本信息：名称、型号、规格、价格区间
2. 核心功能特点：3-5个主要功能点，每个功能用1-2句话说明
3. 目标用户群体：明确的用户画像和使用场景
4. 竞争优势：与同类产品的差异化优势

文案结构要求：
1. 吸引力标题：包含核心卖点的标题
2. 产品概述：2-3句话的产品总体介绍
3. 功能亮点：分点详述核心功能
4. 用户价值：说明产品能为用户解决什么问题
5. 行动召唤：明确的购买或了解更多的引导

输出格式：
- 字数控制在300-500字
- 使用简洁有力的语言
- 突出产品的独特价值
- 包含适当的情感化表达
```

## 🛠️ 故障排除

### 常见问题

1. **模板解析失败**
   - 检查JSONB格式是否正确
   - 验证system和user字段是否存在

2. **API调用错误**
   - 确认OpenAI API密钥配置
   - 检查消息格式是否正确

3. **兼容性问题**
   - 运行测试脚本验证
   - 检查旧格式的兼容处理

### 调试工具

- 测试脚本：`scripts/test-system-user-templates.js`
- 日志输出：查看API调用日志
- 数据库查询：直接查询optimization_template字段

## 📈 性能监控

- 优化请求成功率
- 响应时间统计
- 用户满意度反馈
- 模板使用频率分析

## 🔄 未来扩展

1. **动态System模板**：支持多个System模板版本
2. **A/B测试**：不同模板版本的效果对比
3. **用户自定义**：允许用户自定义优化模板
4. **智能推荐**：基于历史数据推荐最佳模板
