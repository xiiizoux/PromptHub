# 更新日志

## [2.6.0] - 2025-07-04

### 🎉 重大功能更新：Context Engineering 完全支持

#### 新增功能
1. **Context Engineering 完整实现**：
   - 支持智能上下文适配和动态内容调整
   - 三种处理流水线：default（完整）、fast（快速）、deep（深度）
   - 完整的用户级认证和上下文隔离

2. **动态工具调用增强**：
   - 自动发现和调用服务器端新增工具
   - 向后兼容所有现有工具
   - 智能错误处理和用户友好提示

3. **性能和稳定性优化**：
   - 改进响应格式化逻辑
   - 增强长内容的完整显示
   - 优化认证机制和会话管理

#### 技术改进
- MCP 2024-11-05 协议完全兼容
- 用户级 API 密钥 SHA256 哈希验证修复
- 详细的性能监控和日志记录
- 21+ 个工具的全面测试验证

#### 测试验证
- Context Engineering 三种流水线全部测试通过
- 性能基准：default(~880ms)、fast(~420ms)、deep(~580ms)
- 完整的 MCP 协议兼容性验证

## [2.5.0] - 2025-06-28

### 🚀 重大功能升级：三大类别重构与文件类型检测优化

#### 新增功能
1. **三大类别系统重构**：
   - 完全重构为对话(chat)、图片(image)、视频(video)三大类别
   - 支持图片和视频提示词的完整生命周期管理
   - 新增媒体文件上传和预览功能

2. **智能文件类型检测**：
   - 集成`file-type`库，基于文件内容进行MIME类型检测
   - 解决multer检测不准确的问题，提高文件上传安全性
   - 支持真实MP4、PNG等媒体文件的准确识别

3. **增强的存储和搜索**：
   - `unified_store`工具支持图片和视频提示词存储
   - `unified_search`工具支持按类别筛选和媒体预览
   - 完整的preview_asset_url支持

#### 技术改进
- 优化文件上传性能：只检测前4KB进行类型识别
- 增强错误处理：完善的降级机制和日志记录
- 代码质量提升：常量化MIME类型列表，提高可维护性
- 安全性增强：基于文件内容的严格类型验证

#### 测试验证
- 完整测试图片和视频文件上传功能
- 验证真实1.3MB MP4文件的处理能力
- 确认三大类别的存储和搜索功能正常

#### 兼容性
- 向后兼容现有对话类型提示词
- 新增功能不影响现有工具调用方式
- 保持API接口的一致性

## [2.3.1] - 2024-01-30

### 🔧 MCP优化功能问题修复

#### 问题修复
1. **优化器保存提示优化**：
   - 改进`prompt_optimizer`工具的保存引导，从简单提示变为明确的"是否需要保存"问答式交互
   - 提供更清晰的保存步骤指导，包含完整的`unified_store`调用示例
   - 在工具描述中添加明确的"⚠️ 仅分析优化，不会自动保存，需明确的保存指令才能调用unified_store保存"警告

2. **兼容模型缺失问题修复**：
   - 修复`unified_store`工具在某些情况下保存空`compatible_models`数组的问题
   - 改进兼容模型的默认值逻辑：当`compatible_models`为空时，自动使用`getDefaultModelTags()`
   - 添加详细的兼容模型调试日志，便于排查问题
   - 确保存储报告正确显示兼容模型信息

#### 技术改进
- 优化提示词优化器的用户引导文案，提供更清晰的操作指引
- 增强存储过程的日志输出，包含兼容模型的详细信息
- 改进错误处理和降级机制，确保兼容模型字段始终有有效值

#### 兼容性
- 向后兼容，现有工具调用方式不变
- 新的优化提示和兼容模型修复不影响现有功能
- 存储报告格式保持一致，仅增加调试信息

#### 使用建议
- **优化流程**：使用`prompt_optimizer`获取优化建议 → 手动调用`unified_store`保存
- **兼容模型**：系统会自动为提示词推荐合适的兼容模型，无需手动指定
- **调试信息**：查看存储日志中的`compatible_models`字段确认模型推荐结果

## [2.2.6] - 2025-06-25

### 🗂️ 工具简化优化

#### 主要变更
1. **移除冗余工具**：
   - 删除了 `optimize_and_save` 工具，避免与 `prompt_optimizer` 和 `unified_store` 工具功能重复
   - 简化工具集，从23个工具减少到22个工具
   - 提供更清晰的工作流程和职责分离

2. **优化工作流程**：
   - 推荐使用分离式工作流程：先使用 `prompt_optimizer` 获取优化建议，再使用 `unified_store` 进行智能存储
   - `prompt_optimizer`：专注于提供优化建议和分析（不自动保存）
   - `unified_store`：专注于智能存储和AI分析

#### 技术改进
- 代码简化：移除冗余代码，提升维护性
- 文档更新：更新README和CHANGELOG，反映最新工具集
- 性能优化：减少工具数量，提升响应速度

#### 兼容性
- ✅ 向后兼容：现有工具调用方式不变
- ✅ 功能完整：所有核心功能保持可用
- ✅ 升级建议：建议用户使用新的分离式工作流程

## [2.2.5] - 2024-12-25

### 🐛 重要修复 - 角色前缀显示问题

#### 问题修复
1. **角色前缀清理增强**：
   - 增强了`extractPromptContent`函数中的角色前缀清理逻辑
   - 现在会自动移除"用户:"、"系统:"、"User:"、"System:"、"Assistant:"、"助手:"等前缀
   - 确保在AI客户端中显示的提示词内容不会出现不必要的角色标识

2. **显示一致性改进**：
   - 统一了MCP服务和Web服务的提示词内容显示格式
   - 确保无论通过哪种方式保存的提示词，在显示时都不会出现角色前缀
   - 提升了用户体验的一致性

#### 技术改进
- 优化了内容提取算法，更好地处理不同格式的消息数据
- 改进了前缀检测和清理的正则表达式匹配
- 确保向后兼容，对已存在的数据也能正确处理

#### 影响范围
- 所有AI客户端（Cursor、Claude Desktop等）的搜索结果显示
- MCP工具返回的提示词内容格式
- 用户复制提示词时的内容格式

## [2.3.0] - 2024-01-28

### 🎯 重要修复 - MCP智能优化功能问题修复

#### 问题修复
1. **自动保存问题修复**：
   - 修复了`prompt_optimizer`工具自作主张自动保存的问题
   - 明确在工具描述中说明"仅提供优化建议，不会自动保存"
   - 在优化结果中添加明确的保存指导说明

2. **分类错误修复**：
   - 修复了`unified_store`工具使用模拟AI分析导致分类错误的问题
   - 集成真正的AI分析器(`MCPAIAnalyzer`)进行智能分类
   - 改进了默认分析逻辑，基于内容特征进行智能分类而非默认"通用"

3. **兼容模型缺失修复**：
   - 修复了保存提示词时缺少`compatible_models`字段的问题
   - 集成智能模型推荐功能，根据提示词内容自动推荐合适的AI模型
   - 确保所有保存的提示词都包含兼容模型信息

#### 新增功能
4. **移除`optimize_and_save`工具**：
   - 删除了多余的`optimize_and_save`工具，避免与优化和存储工具的功能重复
   - 简化工具集，用户可以分别使用`prompt_optimizer`和`unified_store`工具

#### 技术改进
- 升级AI分析逻辑，使用真正的AI分析器替代模拟分析
- 改进智能分类算法，支持20个预设分类的准确识别
- 优化模型推荐算法，根据内容特征智能推荐兼容模型
- 增强错误处理和降级机制，确保服务稳定性

### 📋 使用建议
- **使用`prompt_optimizer`工具**获取提示词优化建议（不会自动保存）
- **使用`unified_store`工具**进行智能存储，提供准确的AI分析和分类
- **工作流程**：先使用`prompt_optimizer`优化，再使用`unified_store`保存

### 🔧 兼容性
- 向后兼容，现有工具调用方式不变
- 新增工具为可选功能，不影响现有工作流程
- AI分析失败时自动降级到智能默认分析

## [2.1.6] - 2024-12-24

### 🐛 关键修复
- **强制防格式化指令**：在响应开头和结尾添加明确的强制指令，要求AI客户端不要重新格式化内容
- **元数据保护**：添加MCP协议级别的格式化保护指令，包括`preserveFormatting`和`doNotReformat`标志
- **多层防护**：采用多重保护策略，确保提示词内容完整显示

### 🔧 技术改进
- 在搜索响应开头添加：`🚨 **AI客户端请注意：严格按照以下格式显示，不要重新格式化、总结或省略任何内容！** 🚨`
- 在搜索响应结尾添加：`🚨 **重要：以上所有提示词内容必须完整显示给用户，不允许任何形式的重新格式化！** 🚨`
- 添加MCP元数据指令，提供协议级别的格式化保护
- 同时修复了JavaScript和TypeScript版本的格式化逻辑

### 📊 影响范围
- 采用更强硬的方法解决AI客户端重新格式化问题
- 提供多层防护确保内容完整性
- 如果此版本仍无法解决问题，说明需要考虑其他技术方案

## [2.1.5] - 2024-12-24

### 🐛 重要修复
- **修复AI客户端格式化问题**：解决了AI客户端重新格式化搜索结果导致提示词内容不显示的关键问题
- **使用强分隔符格式**：将标准markdown代码块格式替换为强分隔符格式，防止AI客户端过滤内容
- **增强内容显示**：添加明确的内容指示文本"⬇️ 以下是完整的提示词内容，可直接复制使用 ⬇️"

### 🔧 技术改进
- 更新了`formatSearchResults`函数中的内容显示格式，使用`═══════════════════════════════════════`作为分隔符
- 增强了特殊处理逻辑，自动转换代码块格式为强分隔符格式
- 同时修复了JavaScript和TypeScript版本的格式化逻辑

### 📊 影响范围
- 解决了长期存在的AI客户端内容过滤问题
- 用户现在可以直接在搜索结果中看到完整的提示词内容
- 提升了整体用户体验和工具可用性，无需额外请求即可获得完整信息

## [2.1.4] - 2024-12-24

### 🔧 格式优化
- **优化AI客户端兼容性**：将Markdown代码块格式改为更兼容的分隔符格式
- **改进内容显示**：使用"--- 提示词内容开始/结束 ---"替代代码块，确保在所有AI客户端中正确显示
- **增强可读性**：优化搜索结果的格式化，提高内容的可复制性

### 📊 影响范围
- 进一步提升AI客户端中搜索结果的显示兼容性
- 确保提示词内容在各种环境下都能正确显示和复制

## [2.1.3] - 2024-12-24

### 🐛 关键修复
- **修复AI客户端搜索结果内容显示问题**：彻底解决了在AI客户端中搜索结果不显示提示词实际内容的问题
- **优化响应解析逻辑**：修复了MCP适配器错误重新解析已格式化响应的问题
- **确保内容完整性**：现在所有搜索结果都能正确显示完整的提示词内容

### 🔧 技术改进
- 修复了`prompthub-mcp-adapter/index.js`中的响应处理逻辑
- 优化了MCP协议响应的解析流程
- 避免了对已格式化文本的不必要重新处理

### 📊 影响范围
- 所有AI客户端（Cursor、Claude Desktop等）现在都能正确显示搜索结果内容
- 用户可以直接在搜索结果中看到并复制完整的提示词文本
- 解决了长期存在的核心显示问题

## [2.1.2] - 2024-12-24

### 🐛 重要修复
- **修复提示词内容显示问题**：解决了搜索结果中提示词内容不显示的关键问题
- **优化内容提取逻辑**：调整了`extractPromptContent`函数中的检查顺序，优先处理字符串类型的content
- **数据结构适配**：修复了代码逻辑与数据库实际存储结构不匹配的问题

### 🔧 技术改进
- 修复了`prompthub-mcp-adapter/index.js`中的内容提取逻辑
- 修复了`mcp/src/tools/search/unified-search.ts`中的内容提取逻辑
- 确保搜索结果能正确显示完整的提示词内容，而不是只显示标题和描述

### 📊 影响范围
- 所有搜索功能现在都能正确显示提示词的完整内容
- 用户可以直接在搜索结果中看到并复制提示词文本
- 解决了之前多次修改都未能解决的核心显示问题

## [2.1.1] - 2024-12-24

### 🐛 Bug 修复
- 修复搜索结果内容显示格式化问题，统一显示"**提示词内容：**"
- 优化内容提取逻辑，降低最小内容长度阈值从20字符到10字符
- 改进messages字段内容提取的兼容性

### 🔧 改进
- 提高内容提取的成功率，减少"暂无内容预览"的情况
- 优化搜索结果显示的一致性

## [2.1.0] - 2024-12-24

### 🗑️ 重大更新：移除性能分析功能
- **移除性能分析工具**：完全删除了所有性能分析相关的工具和功能
  - 删除 `track_prompt_usage` - 记录提示词使用数据
  - 删除 `submit_prompt_feedback` - 提交提示词反馈
  - 删除 `get_prompt_performance` - 获取提示词性能数据
  - 删除 `generate_performance_report` - 生成性能报告
  - 删除 `create_ab_test` - 创建A/B测试
  - 删除 `get_ab_test_results` - 获取A/B测试结果

### ✅ 保留核心功能
- **核心搜索工具**：`unified_search` - 统一搜索引擎保持完整功能
- **提示词管理**：所有基础的CRUD操作保持不变
- **智能功能**：`unified_store`、`prompt_optimizer` 等核心功能完全保留

### 🎯 改进效果
- **代码简化**：移除了大量性能分析相关代码，提高维护性
- **功能聚焦**：专注于核心的提示词管理和搜索功能
- **性能提升**：适配器启动更快，工具数量减少
- **架构清晰**：与主项目保持一致，不再提供性能分析功能

### 📦 升级说明
- **无破坏性更改**：核心功能保持完全兼容
- **自动更新**：使用 `npx prompthub-mcp-adapter` 自动获取最新版本
- **配置不变**：MCP客户端配置无需修改

## [1.8.1] - 2025-01-19

### 🛠️ 数据库修复
- **外键约束修复**：解决了`prompts_user_id_fkey`外键约束错误，修复存储功能失败问题
- **用户验证增强**：添加了详细的用户存在性验证，提供更好的错误诊断
- **系统用户逻辑清理**：移除了过时的系统用户回退逻辑，简化权限管理
- **存储权限优化**：修复了权限检查中的特殊用户处理问题

### 🔧 技术改进
- 增强了createPrompt方法中的用户验证流程
- 改进了错误日志记录，提供更详细的调试信息
- 优化了数据库插入前的数据验证机制
- 修复了数据库Schema与代码逻辑的不一致问题

### 🐛 问题修复
- 修复了存储功能中的外键约束违反错误
- 解决了API密钥验证成功但存储失败的问题
- 修复了用户ID与数据库约束不匹配的问题

### 📦 部署说明
- 需要执行数据库修复脚本：`scripts/fix_foreign_key_constraints.sql`
- 修复后存储功能应立即恢复正常
- 搜索功能保持稳定，不受此次修复影响

## [1.7.0] - 2024-01-27

### 🎯 重要修复
- **数据库字段一致性修复**：移除了对不存在的`content`字段的错误引用，确保代码与数据库schema完全一致
- **字段使用优化**：正确使用`description`字段作为内容备选，确保搜索结果显示准确

### 🔧 技术改进
- 修复了搜索结果格式化中的字段引用错误
- 优化了内容提取逻辑，提高搜索准确度
- 增强了错误处理和字段验证机制
- 消除了TypeScript类型不匹配问题

### 🛡️ 兼容性
- 向后兼容，无破坏性更改
- 不需要数据迁移
- 提高了系统稳定性和准确性

### 📦 包管理
- 创建了v1.7.0打包文件
- 添加了详细的测试脚本
- 完善了发布说明文档

## [1.6.0] - 2024-01-26

### 新增功能 (Added)
- ✨ **提示词优化工具** (`prompt_optimizer`) - 为第三方AI客户端提供结构化的提示词优化指导
  - 支持8种优化类型：通用、创意、技术、商务、教育、绘图、分析、迭代
  - 提供详细的优化分析和改进建议
  - 支持复杂度控制和多语言输出
  - 特别优化了绘图提示词的处理能力
  - 支持迭代优化模式，可以基于现有提示词进行进一步优化

### 技术改进 (Changed)
- 🔧 更新User-Agent版本标识到1.6.0
- 📦 工具总数增加到30+个，提供更全面的提示词管理功能

### 使用说明
新的提示词优化工具可以通过以下方式调用：
```json
{
  "tool": "prompt_optimizer",
  "parameters": {
    "content": "要优化的提示词内容",
    "optimization_type": "general|creative|technical|business|educational|drawing|analysis|iteration",
    "requirements": "特殊要求或限制条件",
    "complexity": "simple|medium|complex",
    "language": "zh|en"
  }
}
```

# 版本更新日志

## v1.5.0 (2024-12-23)

### 🎉 新功能
- 完善了搜索系统，现在所有搜索操作都能正确执行
- 修复了智能语义搜索(smart_semantic_search)的功能问题
- 优化了搜索操作的稳定性和准确性

### 🔧 技术改进
- 解决了UUID类型错误导致的数据库查询失败问题
- 修复了Supabase行级安全策略(RLS)相关的访问问题
- 使用正确的认证方式，确保数据正常读取
- 为搜索操作创建专门的处理逻辑

### 📊 搜索优化
- 现在可以稳定执行各种搜索操作
- 支持按工具类型、关键词等维度搜索
- 完整的错误日志和异常处理

### 🏷️ 数据结构
搜索操作现在会正确处理：
- 执行时间优化
- 结果准确性提升
- 搜索查询内容解析
- 工具类型识别
- 会话状态管理

## v1.4.0 (之前版本)
- 智能语义搜索功能优化
- 统一搜索接口改进
- 多维度搜索算法增强