import React, { createContext, useContext, useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import { User as SupabaseAuthUser } from '@supabase/supabase-js';
import { supabase } from '@/lib/supabase';
import { User } from '@/types';

// 定义认证上下文的类型
interface AuthContextType {
  user: User | null;
  loading: boolean;
  error: string | null;
  login: (email: string, password: string, remember?: boolean) => Promise<void>;
  register: (username: string, email: string, password: string) => Promise<void>;
  logout: () => Promise<void>;
  checkAuth: () => Promise<boolean>;
  isAuthenticated: boolean;
}

// 创建认证上下文
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// 认证提供者组件
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const router = useRouter();

  // 初始化时检查认证状态
  useEffect(() => {
    const initAuth = async () => {
      await checkAuth();
      setLoading(false);
    };

    initAuth();
  }, []);

  // 检查用户认证状态
  const checkAuth = async (): Promise<boolean> => {
    try {
      // 检查是否使用模拟 Supabase 凭据
      const isUsingMockCredentials = 
        process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
        !process.env.NEXT_PUBLIC_SUPABASE_URL;

      if (isUsingMockCredentials) {
        console.warn('使用模拟凭据检查认证状态，实际部署时请配置 Supabase');
        
        // 检查本地存储中是否有模拟用户
        const mockUserEmail = localStorage.getItem('mock_user_email');
        
        if (mockUserEmail) {
          // 模拟用户已登录
          const mockUser: User = {
            id: '1',
            username: mockUserEmail.split('@')[0],
            email: mockUserEmail,
            role: 'user',
            created_at: new Date().toISOString()
          };
          
          setUser(mockUser);
          setIsAuthenticated(true);
          return true;
        } else {
          setUser(null);
          setIsAuthenticated(false);
          return false;
        }
      }
      
      // 正常 Supabase 认证检查
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        setUser(null);
        setIsAuthenticated(false);
        return false;
      }
      
      // 获取用户信息
      const { data: { user: supaUser } } = await supabase.auth.getUser();
      
      if (supaUser) {
        // 将 Supabase 用户转换为应用用户
        const appUser: User = {
          id: supaUser.id,
          username: supaUser.user_metadata?.username || supaUser.email?.split('@')[0] || '',
          email: supaUser.email || '',
          role: supaUser.app_metadata?.role || 'user',
          created_at: supaUser.created_at || new Date().toISOString()
        };
        
        setUser(appUser);
        setIsAuthenticated(true);
        return true;
      } else {
        // 用户会话无效
        setUser(null);
        setIsAuthenticated(false);
        return false;
      }
    } catch (err) {
      console.error('认证检查失败:', err);
      setUser(null);
      setIsAuthenticated(false);
      return false;
    }
  };

  // 登录
  const login = async (email: string, password: string, remember = false): Promise<void> => {
    setLoading(true);
    setError(null);
    
    try {
      // 检查是否使用模拟 Supabase 凭据
      const isUsingMockCredentials = 
        process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
        !process.env.NEXT_PUBLIC_SUPABASE_URL;
      
      if (isUsingMockCredentials) {
        console.warn('使用模拟凭据进行登录，实际部署时请配置 Supabase');
        
        // 模拟登录成功，仅在开发环境中使用
        if (email && password) {
          // 创建模拟用户
          const mockUser: User = {
            id: '1',
            username: email.split('@')[0],
            email,
            role: 'user',
            created_at: new Date().toISOString()
          };
          
          setUser(mockUser);
          setIsAuthenticated(true);
          return;
        } else {
          throw new Error('登录失败：用户名或密码不能为空');
        }
      }
      
      // 正常 Supabase 登录
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        throw error;
      }
      
      if (data.user) {
        // 将 Supabase 用户转换为应用用户
        const appUser: User = {
          id: data.user.id,
          username: data.user.user_metadata?.username || data.user.email?.split('@')[0] || '',
          email: data.user.email || '',
          role: data.user.app_metadata?.role || 'user',
          created_at: data.user.created_at || new Date().toISOString()
        };
        
        setUser(appUser);
        setIsAuthenticated(true);
      } else {
        throw new Error('登录失败：未能获取用户信息');
      }
    } catch (err: any) {
      console.error('登录失败:', err);
      setError(err.message || '登录失败，请检查您的凭据');
      throw err;
    } finally {
      setLoading(false);
    }
  };

  // 注册
  const register = async (username: string, email: string, password: string): Promise<void> => {
    setLoading(true);
    setError(null);
    
    try {
      // 检查是否使用模拟 Supabase 凭据
      const isUsingMockCredentials = 
        process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
        !process.env.NEXT_PUBLIC_SUPABASE_URL;
      
      if (isUsingMockCredentials) {
        console.warn('使用模拟凭据进行注册，实际部署时请配置 Supabase');
        
        // 模拟注册成功，仅在开发环境中使用
        if (username && email && password) {
          // 模拟注册成功
          return;
        } else {
          throw new Error('注册失败：所有字段都是必填的');
        }
      }
      
      // 正常 Supabase 注册
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            username,
            full_name: username
          }
        }
      });
      
      if (error) {
        throw error;
      }
      
      // 注册成功，但可能需要邮箱验证
      return;
    } catch (err: any) {
      console.error('注册失败:', err);
      setError(err.message || '注册失败，请稍后再试');
      throw err;
    } finally {
      setLoading(false);
    }
    
    // 获取用户信息
    const { data: { user: supaUser } } = await supabase.auth.getUser();
    
    if (supaUser) {
      // 将 Supabase 用户转换为应用用户
      const appUser: User = {
        id: supaUser.id,
        username: supaUser.user_metadata?.username || supaUser.email?.split('@')[0] || '',
        email: supaUser.email || '',
        role: supaUser.app_metadata?.role || 'user',
        created_at: supaUser.created_at || new Date().toISOString()
      };
      
      setUser(appUser);
      setIsAuthenticated(true);
      return true;
    } else {
      // 用户会话无效
      setUser(null);
      setIsAuthenticated(false);
      return false;
    }
  } catch (err) {
    console.error('认证检查失败:', err);
    setUser(null);
    setIsAuthenticated(false);
    return false;
  }
};

// 登录
const login = async (email: string, password: string, remember = false): Promise<void> => {
  setLoading(true);
  setError(null);
  
  try {
    // 检查是否使用模拟 Supabase 凭据
    const isUsingMockCredentials = 
      process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
      !process.env.NEXT_PUBLIC_SUPABASE_URL;
    
    if (isUsingMockCredentials) {
      console.warn('使用模拟凭据进行登录，实际部署时请配置 Supabase');
      
      // 模拟登录成功，仅在开发环境中使用
      if (email && password) {
        // 创建模拟用户
        const mockUser: User = {
          id: '1',
          username: email.split('@')[0],
          email,
          role: 'user',
          created_at: new Date().toISOString()
        };
        
        setUser(mockUser);
        setIsAuthenticated(true);
        return;
      } else {
        throw new Error('登录失败：用户名或密码不能为空');
      }
    }
    
    // 正常 Supabase 登录
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) {
      throw error;
    }
    
    if (data.user) {
      // 将 Supabase 用户转换为应用用户
      const appUser: User = {
        id: data.user.id,
        username: data.user.user_metadata?.username || data.user.email?.split('@')[0] || '',
        email: data.user.email || '',
        role: data.user.app_metadata?.role || 'user',
        created_at: data.user.created_at || new Date().toISOString()
      };
      
      setUser(appUser);
      setIsAuthenticated(true);
    } else {
      throw new Error('登录失败：未能获取用户信息');
    }
  } catch (err: any) {
    console.error('登录失败:', err);
    setError(err.message || '登录失败，请检查您的凭据');
    throw err;
  } finally {
    setLoading(false);
  }
};

// 注册
const register = async (username: string, email: string, password: string): Promise<void> => {
  setLoading(true);
  setError(null);
  
  try {
    // 检查是否使用模拟 Supabase 凭据
    const isUsingMockCredentials = 
      process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
      !process.env.NEXT_PUBLIC_SUPABASE_URL;
    
    if (isUsingMockCredentials) {
      console.warn('使用模拟凭据进行注册，实际部署时请配置 Supabase');
      
      // 模拟注册成功，仅在开发环境中使用
      if (username && email && password) {
        // 模拟注册成功
        return;
      } else {
        throw new Error('注册失败：所有字段都是必填的');
      }
    }
    
    // 正常 Supabase 注册
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          username,
          full_name: username
        }
      }
    });
    
    if (error) {
      throw error;
    }
    
    // 注册成功，但可能需要邮箱验证
    return;
  } catch (err: any) {
    console.error('注册失败:', err);
    setError(err.message || '注册失败，请稍后再试');
    throw err;
  } finally {
    setLoading(false);
  }
};

// 登出
const logout = async (): Promise<void> => {
  setLoading(true);
  
  try {
    // 检查是否使用模拟 Supabase 凭据
    const isUsingMockCredentials = 
      process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://example.supabase.co' || 
      !process.env.NEXT_PUBLIC_SUPABASE_URL;
      
    if (isUsingMockCredentials) {
      console.warn('使用模拟凭据登出，实际部署时请配置 Supabase');
      
      // 清除本地存储中的模拟用户
      localStorage.removeItem('mock_user_email');
    } else {
      // 正常 Supabase 登出
      const { error } = await supabase.auth.signOut();
      
      if (error) {
        throw error;
      }
    }
    
    // 清除应用状态
    setUser(null);
    setIsAuthenticated(false);
  } catch (err: any) {
    console.error('登出失败:', err);
    setError(err.message || '登出失败，请稍后再试');
  } finally {
    setLoading(false);
  }
};

const value = {
  user,
  loading,
  error,
  login,
  register,
  logout,
  checkAuth,
  isAuthenticated
};
    isAuthenticated
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

// 自定义Hook，用于访问认证上下文
export const useAuth = (): AuthContextType => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

// 保护路由的高阶组件
export const withAuth = <P extends object>(Component: React.ComponentType<P>): React.FC<P> => {
  const AuthComponent: React.FC<P> = (props) => {
    const { isAuthenticated, loading } = useAuth();
    const router = useRouter();

    useEffect(() => {
      // 如果认证状态已加载完成且用户未认证，则重定向到登录页面
      if (!loading && !isAuthenticated) {
        router.replace(`/auth/login?returnUrl=${encodeURIComponent(router.asPath)}`);
      }
    }, [isAuthenticated, loading, router]);

    // 在加载中或未认证时显示加载界面
    if (loading || !isAuthenticated) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="text-center">
            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-primary-500 border-r-transparent"></div>
            <p className="mt-4 text-gray-600">正在验证身份...</p>
          </div>
        </div>
      );
    }

    // 认证通过，渲染原始组件
    return <Component {...props} />;
  };

  // 设置组件显示名称
  const displayName = Component.displayName || Component.name || 'Component';
  AuthComponent.displayName = `withAuth(${displayName})`;

  return AuthComponent;
};
